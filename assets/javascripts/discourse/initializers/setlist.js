// TODO...
// * un-hardcode data
// * handle multiple shows on single date... `showorder`
// * tweak display of setlist (split up sets)... `setnumber`

import tippy from 'tippy.js';

import { withPluginApi } from 'discourse/lib/plugin-api';
import ComposerController from 'discourse/controllers/composer';
import { addBlockDecorateCallback, addTagDecorateCallback } from 'discourse/lib/to-markdown';

const PLUGIN_NAME = 'setlist'; // TBD Does this have to match the filename?
const HTML_CLASS_NAME = 'kglwSetlist';
const HTML_CLASS_NAME_INVALID = `${HTML_CLASS_NAME}-invalid`;
const HTML_CLASS_NAME_PROCESSED = `${HTML_CLASS_NAME}-processed`;
const HTML_CLASS_NAME_PROCESSING = `${HTML_CLASS_NAME}-processing`;
const REGEX_DATE_FORMAT = /^(?<year>\d{4})-(?<month>\d{2})-(?<day>\d{2})(?!#(?<which>\d))?$/

function log(...msgs) {
  console.log('%cKGLW', 'color:chartreuse;background:black;padding:0.2rem;border-radius:1rem', ...msgs)
}

async function doTheSetlist(setlistElement) {
  log('doTheSetlist!!', fetch, setlistElement);
  if (!fetch)
    return console.error('no fetch...');
  setlistElement.classList.add(HTML_CLASS_NAME_PROCESSING);
  const matches = setlistElement.innerHTML.match(REGEX_DATE_FORMAT);
  if (matches.length < 4 || matches.length > 5)
    return console.error('no regex matches', setlistElement.innerHTML, REGEX_DATE_FORMAT);
  const {year, month, day, which} = matches.groups
  const date = `${year}-${month}-${day}`
  const showData = //(await (await fetch(`https://kglw.net/api/v1/shows/showdate/${date}.json`)).json()).data
   [
    {
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "artist_id": 1,
        "artist": "King Gizzard & the Lizard Wizard",
        "showtitle": "",
        "venue_id": 617,
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "showorder": 1,
        "show_year": 2022,
        "show_day": 2,
        "show_dayname": "Sunday",
        "show_month": 10,
        "show_monthname": "October",
        "updated_at": "2023-07-09 23:02:19",
        "created_at": "2023-03-08 21:31:41"
    }
  ]
  const setlistData = //(await (await fetch(`https://kglw.net/api/v1/setlists/showdate/${date}.json`)).json()).data
   [
    {
        "uniqueid": "839",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 212,
        "songname": "The Dripping Tap",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 1,
        "transition_id": 2,
        "transition": " > ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "the-dripping-tap",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "840",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 242,
        "songname": "Wah Wah",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 2,
        "transition_id": 2,
        "transition": " > ",
        "footnote": "With The River intro",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "wah-wah",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "841",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 171,
        "songname": "Road Train",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 3,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "road-train",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "842",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 105,
        "songname": "Ice V",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 4,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "Debut",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "ice-v",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "843",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 32,
        "songname": "Black Tooth",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 5,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "black-tooth",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "844",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 182,
        "songname": "Shanghai",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 6,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "shanghai",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "845",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 240,
        "songname": "Venusian 2",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 7,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "venusian-2",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "846",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 218,
        "songname": "The Great Chain of Being",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 8,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "the-great-chain-of-being",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "847",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 57,
        "songname": "Doom City",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 9,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "doom-city",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "848",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 146,
        "songname": "Nuclear Fusion",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 10,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "nuclear-fusion",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "849",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 147,
        "songname": "O.N.E.",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 11,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "With Straws in the Wind intro",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "o-n-e",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "850",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 10,
        "songname": "All Is Known",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 12,
        "transition_id": 2,
        "transition": " > ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "all-is-known",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "851",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 162,
        "songname": "Pleura",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 13,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "pleura",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "852",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 197,
        "songname": "Straws In The Wind",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "1",
        "position": 14,
        "transition_id": 4,
        "transition": "  ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "straws-in-the-wind",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "853",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 180,
        "songname": "Self-Immolate",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 15,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "self-immolate",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "854",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 81,
        "songname": "Gaia",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 16,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "With drum solo",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "gaia",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "855",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 219,
        "songname": "The Grim Reaper",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 17,
        "transition_id": 2,
        "transition": " > ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "the-grim-reaper",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "856",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 166,
        "songname": "Presumptuous",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 18,
        "transition_id": 2,
        "transition": " > ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "presumptuous",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "857",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 189,
        "songname": "Sleepwalker",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 19,
        "transition_id": 2,
        "transition": " > ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "sleepwalker",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "858",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 118,
        "songname": "Iron Lung",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 20,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "iron-lung",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "859",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 20,
        "songname": "Ambergris",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 21,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "ambergris",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "860",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 226,
        "songname": "The Reticent Raconteur",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 22,
        "transition_id": 2,
        "transition": " > ",
        "footnote": "With Leah Senior narration",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "the-reticent-raconteur",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "861",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 224,
        "songname": "The Lord of Lightning",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 23,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "With Leah Senior narration",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "the-lord-of-lightning",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "862",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 47,
        "songname": "Crumbling Castle",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 24,
        "transition_id": 2,
        "transition": " > ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "crumbling-castle",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "863",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 214,
        "songname": "The Fourth Colour",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 25,
        "transition_id": 1,
        "transition": ", ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "the-fourth-colour",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    },
    {
        "uniqueid": "864",
        "show_id": 1678311101,
        "showdate": "2022-10-02",
        "showtitle": "",
        "artist": "King Gizzard & the Lizard Wizard",
        "song_id": 19,
        "songname": "Am I In Heaven?",
        "artist_id": 1,
        "permalink": "king-gizzard-the-lizard-wizard-october-2-2022-william-randolph-hearst-greek-theatre-berkeley-ca-usa.html",
        "settype": "Set",
        "setnumber": "2",
        "position": 26,
        "transition_id": 5,
        "transition": "  ",
        "footnote": "",
        "isjamchart": 0,
        "jamchart_notes": "",
        "venue_id": 617,
        "shownotes": "This show featured the debut of Ice V. Wah Wah began with the intro to The River, and subsequently contained Crumbling Castle and The River teases. O.N.E. began with the intro to Straws in the Wind instead of the customary intro. Straws in the Wind was dedicated to Russell Brand. Smoke and Mirrors was played over the PA as the setbreak music. Gaia featured a Cavs drum solo. Ambergris contained an Ice V tease. Before The Reticent Raconteur, Leah Senior was introduced to the stage as “The Original Balrog” and Joey gave a shoutout to her live bass player Jack [Robbins], with the bonus trivia that he was also in Stu’s first band Almacknjack. The Reticent Raconteur and The Lord of Lightning featured narration by Leah Senior. Am I in Heaven? contained The Dripping Tap teases.",
        "showyear": 2022,
        "showorder": 1,
        "opener": "Leah Senior",
        "tour_id": 49,
        "tourname": "World Tour 2022 Fall",
        "soundcheck": "",
        "isverified": 1,
        "slug": "am-i-in-heaven",
        "isoriginal": 1,
        "original_artist": "",
        "venuename": "William Randolph Hearst Greek Theatre",
        "city": "Berkeley",
        "state": "CA",
        "country": "USA",
        "isreprise": 0,
        "isjam": 0
    }
  ]
  log('doTheSetlist', {showData, setlistData, tippy});
  const setlist = setlistData.map(song => `${song.songname}${song.transition}`).join('') // TODO handle multiple sets
  tippy(setlistElement, {
    content: `${showData.showdate} @ ${showData.venuename}\n\n${setlist}`,
    placement: 'top-start',
    duration: 0,
    theme: 'translucent',
    interactive: true,
  });
  setlistElement.classList.remove(HTML_CLASS_NAME_PROCESSING);
  setlistElement.classList.add(HTML_CLASS_NAME_PROCESSED);
}

export function initializeSetlistCode(api) {
  // add button to Editing Content menu (...?)
  api.addToolbarPopupMenuOptionsCallback(() => ({ action: 'insertSetlist', icon: 'list', label: 'setlist.title' }));
  ComposerController.reopen({
    actions: {
      insertSetlist() { // matches action prop passed to addToolbarPopupMenuOptionsCallback
        this.get('toolbarEvent').applySurround(
          '[setlist]',
          '[/setlist]',
          'setlist_text', // locale string js.composer.setlist_text
          { multiline: false, useBlockMode: false }
        );
      },
    },
  });

  // convert nodes back to bbcode
  addTagDecorateCallback(function (text) {
    log('addTagDecorateCallback', text, this.element);
    if ([...this.element.classList].includes(HTML_CLASS_NAME)) {
      this.prefix = '[setlist]';
      this.suffix = '[/setlist]';
    }
  });

  addBlockDecorateCallback(function (text) {
    log('addBlockDecorateCallback', text, this.element);
    if (this.element.name === 'div' && [...this.element.classList].includes(HTML_CLASS_NAME)) {
      this.prefix = '[setlist]';
      this.suffix = '[/setlist]';
      return text.trim();
    }
  });

  // decorate "cooked" content (after it's been rendered)
  // https://github.com/discourse/discourse/blob/1526d1f97d46/app/assets/javascripts/discourse/app/lib/plugin-api.js#L369
  api.decorateCookedElement(function(cookedElement) {
    cookedElement.querySelectorAll(`.${HTML_CLASS_NAME}`).forEach((setlistElem) => {
      log('decorateCookedElement...', setlistElem);
      setlistElem.classList.add(HTML_CLASS_NAME);
      if (REGEX_DATE_FORMAT.test(setlistElem.innerText)) {
        const removeListeners = (elem) => {
          elem.removeEventListener('click', clickHandler);
          elem.removeEventListener('keydown', keydownHandler);
        };
        const clickHandler = () => {
          removeListeners(setlistElem);
          doTheSetlist(setlistElem);
        };
        const keydownHandler = ({key}) => {
          if (key === 'Enter') {
            removeListeners(setlistElem);
            doTheSetlist(setlistElem);
          }
        };
        setlistElem.addEventListener('click', clickHandler);
        setlistElem.addEventListener('keydown', keydownHandler);
      } else {
        setlistElem.classList.add(HTML_CLASS_NAME_INVALID)
      }
    });
  }, {
    afterAdopt: true, // decorate html content after it is adopted by the main `document` (not in a detached DOM)
    id: HTML_CLASS_NAME,
  });
}

export default {
  name: PLUGIN_NAME,
  initialize(container) {
    const {kglwSetlist_enabled} = container.lookup('site-settings:main');
    if (kglwSetlist_enabled)
      withPluginApi('1.3.0', initializeSetlistCode);
  },
};
